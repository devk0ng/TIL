# ì˜ì†ì„± ì»¨íƒìŠ¤íŠ¸

JPAì—ì„œ ê°€ìž¥ ì¤‘ìš”í•œ ê²ƒì„ ë‘ê°€ì§€ ë½‘ìœ¼ë¼ë©´ ê°ì²´ì™€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì˜ ë§¤í•‘ê³¼ **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸**ë¥¼ ë½‘ì„ ìˆ˜ ìžˆì„ ê²ƒ ê°™ë‹¤!!

EntityManagerëŠ” ìš”ì²­ë§ˆë‹¤ ìƒê²¨ì„œ databaseì— ëŒ€í•œ connectionì„ ì–»ì€ í›„ databaseì— í•„ìš”í•œ ìž‘ì—…ì„ í•œë‹¤!!

ì´ë•Œ EntityManager ê°ì²´ emì— ëŒ€í•´ em.persist()ë¥¼ í•˜ë©´ databaseì— insertê°€ ëœë‹¤ê³  ìƒê°ì„ í•˜ê³ ìžˆìœ¼ë‚˜

ì •í™•ížˆëŠ” persistëŠ” ë””ë¹„ì— ì €ìž¥í•˜ëŠ”ê²Œ ì•„ë‹ˆë¼ ì˜ì†ì„± ì»¨íƒìŠ¤íŠ¸ì— ì €ìž¥í•˜ëŠ”ê±°ì•¼!!

ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ë¬´ì—‡ì´ëƒ?? íì‘ìœ¼ìœ¼ìŒ... ëˆˆì— ë³´ì´ì§€ ì•ŠëŠ” ì–´ë–¤ ë…¼ë¦¬ì ì¸ ê°œë…ì´ë¼ê³  ìƒê°í•˜ë©´ ë˜ëŠ”ë° ì—”í‹°í‹° ë©”ë‹ˆì €ë¥¼ í†µí•´ ì´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìžˆë‹¤! ì •ë„ë¡œë§Œ ëŠë‚Œ ìž¡ê³  ìš°ì„  ê°€ì¦ˆì•„~!

ì—”í‹°í‹°ê°€ ë­ë¼ê³  í–ˆì¥?? jpaê°€ ê´€ë¦¬í•˜ëŠ” ë†ˆì´ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤ê³  í–ˆì§€.

ì´ ì—”í‹°í‹°ì—ëŠ” ìƒëª…ì£¼ê¸°ê°€ ìžˆì–´.

- ë¹„ì˜ì†
- ì˜ì†
- ì¤€ì˜ì†
- ì‚­ì œ

ì´ë ‡ê²Œ 4ê°€ì§€ê°€ ì¡´ìž¬í•´.

ìœ„ 4ê°€ì§€ë¥¼ íë¦„ì— ë”°ë¼ ìŠ¤ìœ½ ì´ì•¼ê¸°í•´ë³´ë„ë¡ í•˜ê² ìŠ´ë !!

ë¨¼ì € **ë¹„ì˜ì†**ì„ ë³´ìž!!

ë¹„ì˜ì†ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ëŠ” ì „í˜€ ê´€ê³„ê°€ ì—†ëŠ” ìƒˆë¡œìš´ ìƒíƒœì•¼!! ê·¸ëƒ¥ newë§Œ í–ˆì„ ë•Œ ê·¸ëŸ¬í•œ ìƒíƒœê² ì§€??

```java
//Exampleì€ Entity
Example ex = new Example();
ex.setId("ex1");
ex.setName("example1");
```

ìœ„ì— ë³´ì´ëŠ”ê²Œ ë”± ë¹„ì˜ì† ìƒíƒœì¸ê±°ì•¼!!

ì–˜ê°€ ì˜ì†ì´ ë˜ë ¤ë©´?? ê·¸ ì „ì— ë¨¼ì € **ì˜ì†**ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— manage ì¦‰ ê´€ë¦¬ë˜ëŠ” ìƒíƒœë¼ê³  ìƒê°í•˜ë©´ ë¼!!

```java
EntityManger em = emf.createEntityManager();
em.getTransaction().begin();

em.persist(ex);
```

ì´ë ‡ê²Œ í•˜ë©´ ì € exëŠ” ì˜ì†ìƒíƒœê°€ ë˜ì—ˆê³  ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ê´€ë¦¬ ëŒ€ìƒì´ ë˜ì—ˆë‹¤ê³  ìƒê°í•˜ë©´ ë˜ëŠ”ê±°ì•¼!!

ë‹¤ìŒìœ¼ë¡œ ì¤€ì˜ì†ê³¼ ì‚­ì œëŠ” í•¨ê»˜ ìŠ¥ í•´ì¹˜ì›Œ ë²„ë¦´ê²Œ

```java
//ex ë¥¼ ì˜ì†ì„± ì»¨í…ŒìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ -> ì¤€ì˜ì† ìƒíƒœ
em.detach(ex);

//ê°ì²´ë¥¼ ì‚­ì œí•œ ìƒíƒœ(ì‚­ì œ)
em.remove(ex);
```

ì´ë ‡ê²Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ìš©í•  ë•Œì˜ ì´ì ì€ ë¬´ì—‡ì¼ê¹Œ?? ë‹¤ìŒê³¼ ê°™ì• 

- 1ì°¨ ìºì‹œ
- ë™ì¼ì„±(identity) ë³´ìž¥
- íŠ¸ëžœìž­ì…˜ì„ ì§€ì›í•˜ëŠ” ì“°ê¸° ì§€ì—°
- Dirty Checking
- Lazy Loading

**1ì°¨ ìºì‹œ**

ë¨¼ì € 1ì°¨ìºì‹œì— ëŒ€í•´ì„œ ì•Œì•„ë³´ìž!! ì˜ì†ì„± ì»¨í…ŒìŠ¤íŠ¸ë¥¼ 1ì°¨ìºì‹œë¼ê³  ìƒê°í•´ë„ No Problem ì´ì•¼!!

ìš°ì„  ì•„ëž˜ ì½”ë“œë¥¼ ë³´ìž

```java
//ì—”í‹°í‹°ë¥¼ ìƒì„±í•œ ìƒíƒœ(ë¹„ì˜ì†)
Sample s = new Sample();
s.setId("s1");
s.setName("ìƒ˜í”Œ1");

//ì—”í‹°í‹°ë¥¼ ì˜ì† = 1ì°¨ ìºì‹œì— ì €ìž¥ë¨
em.persist(s);
```

ìž ì´ë ‡ê²Œ ë„£ê³  ë‚˜ë©´ ì–´ë–»ê²Œ ë˜ëŠëƒ?? ì£¼ì„ì—ë„ ì í˜€ìžˆë“¯ì´ 1ì°¨ìºì‹œì— ì €ìž¥ë˜ì—ˆë‹¤ê³  ìƒê°í•´ë„ ë¬´ë°©í•´.

1ì°¨ìºì‹œëŠ” Idë¥¼ key, entityë¥¼ valueë¡œ ë„£ì–´ë†“ì€ í•´ì‰¬? í…Œì´ë¸”? êµ¬ì¡°ë¼ê³  ìƒê°í•˜ë©´ ì‰¬ìš¸ ê²ƒ ê°™ì• 

ìœ„ì˜ ì˜ˆì—ì„œëŠ”

s1 keyì— së¼ëŠ” ì—”í‹°í‹°ê°€ ë§¤í•‘ë˜ì–´ ìžˆê² ì§€.

ì´ ìƒí™©ì—ì„œ

```java
//1ì°¨ ìºì‹œì—ì„œ ì¡°íšŒ
Sample findSample = em.find(Sample.class, "s1");
```

ì´ëŸ°ì‹ìœ¼ë¡œ findë¥¼ ì‹¤í–‰í•˜ê²Œ ë˜ë©´ ìš°ì„ ì ìœ¼ë¡œ 1ì°¨ìºì‹œì—ì„œ s1ì´ë¼ëŠ” idë¥¼ í†µí•´ entityë¥¼ ì°¾ê²Œ ë¼!! ë§Œì•½ ì°¾ìžë‚˜?? ê·¸ëŸ¼ dbì— ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ì§€ ì•Šê³  ê·¸ ë†ˆì„ ë“¤ê³ ì˜¤ê²Œ ë˜ëŠ”ê±°ì§€!!

ê·¸ëŸ¼ ë§Œì•½ì— findë¥¼ í•˜ì˜€ëŠ”ë° í•´ë‹¹í•˜ëŠ” entityê°€ 1ì°¨ ìºì‹œì— ì—†ë‹¤ë©´ (ì˜ì† ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´) ì–´ë–»ê²Œ í•˜ëŠëƒ!?

â†’ databaseì— ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë¥¼ ë“¤ê³ ì™€ ì´ ë°ì´í„°ì˜ keyì™€ ê°ì²´ ì •ë³´ë¥¼ í†µí•´ 1ì°¨ìºì‹œì— ì €ìž¥í•¨ìœ¼ë¡œì¨ ì˜ì†ìƒíƒœë¡œ ë§Œë“¤ê³  ì‚¬ìš©ìžì—ê²Œ ë°˜í™˜í•´ì¤˜.

**ë™ì¼ì„± ë³´ìž¥**

ì´ëŠ” ìœ„ì˜ ë‚´ìš©ê³¼ ì´ì–´ì§„ë‹¤ê³ ë´ë„ ë¬´ë°©í•´!! ìœ„ì˜ ìž‘ì„±í•œ ì½”ë“œì—ì„œ ì´ì–´ë‚˜ê°€ì„œ ì§„í–‰í•´ë³¼ê²Œ

```java
Sample a = em.find(Sample.class, "s1");
Sample b = em.find(Sample.class, "s1");

System.out.println(a == b); //true ë°˜í™˜
```

ì´ë ‡ê²Œ ê°™ì€ ì •ë³´ë¥¼ í†µí•´ ê°€ì ¸ì˜¨ Entityì— ëŒ€í•´ì„œëŠ” ë™ì¼ì„±ì„ ë³´ìž¥í•´ì¤˜!! ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ê´€ë¦¬í•˜ëŠ” ìƒíƒœê°€ ì˜ì†ìƒíƒœë¼ê³  í–ˆê³  ì´ëŠ” ê³§ 1ì°¨ìºì‹œì— í•´ë‹¹ Entityê°€ ì¡´ìž¬í•œë‹¤ê³  ë´ë„ ë˜ëŠ” ê²ƒì´ë¼ê³  í–ˆì§€.

ê·¸ëŸ° ê²½ìš°ì— 1ì°¨ìºì‹œì—ì„œ ê°€ì ¸ì˜¤ëŠ” EntityëŠ” ë‹¹ì—°ížˆ ë™ì¼í•œ idë¡œ ì¡°íšŒí•œ ê²°ê³¼ì¼ ê²ƒì´ê³  ê°™ì€ ê°ì²´ìž„ì„ ë³´ìž¥ë°›ì„ ìˆ˜ ìžˆê²Œ ë˜ëŠ”ê±°ì§€!!

**â†’ 1ì°¨ìºì‹œ ë•ë¶„ì— REPEATABLE READ ë“±ê¸‰ì˜ íŠ¸ëžœìž­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì„ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì•„ë‹Œ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì°¨ì›ì—ì„œ ì œê³µë°›ì„ ìˆ˜ ì´ì¨!!**

**íŠ¸ëžœìž­ì…˜ì„ ì§€ì›í•˜ëŠ” ì“°ê¸°ì§€ì—°**

JPAì—ì„œ ëª¨ë“  ê²ƒì´ ì¼ì–´ë‚˜ëŠ” ë‹¨ìœ„ëŠ” íŠ¸ëžœì ì…˜ì´ë¼ê³  ìƒê°í•´ë„ ë¬´ë°©í•´!! íŠ¸ëžœì ì…˜ì´ë¼ëŠ” ë‹¨ìœ„ë¡œ ë™ìž‘ì´ ë˜ì–´ì§€ê¸°ì— JPAì˜ ì—¬ëŸ¬ ê¸°ëŠ¥ë“¤ì´ ì´ìš© ê°€ëŠ¥í•˜ê²Œ ë˜ëŠ”ê±°ì•¼!!

ê·¸ë¦¬ê³  TRANSACTIONì´ ì»¤ë°‹ë˜ëŠ” ìˆœê°„ ì¿¼ë¦¬ ì €ìž¥ì†Œ(ì‹¤ì œ persistë“±ì˜ ì½”ë“œê°€ ì‹¤í–‰ë  ë•Œ ë°”ë¡œ ì¿¼ë¦¬ê°€ ë‚ ë¼ê°€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì¿¼ë¦¬ë¥¼ ìƒì„± í›„ ìž„ì‹œ ì €ìž¥ì†Œì— ì €ìž¥ í•´ ë†“ëŠ”ë° í•´ë‹¹ ì €ìž¥ì†Œë¥¼ ì¿¼ë¦¬ ì €ìž¥ì†Œë¼ ë¶€ë¥´ê² ë‹¤)ì˜ ì¿¼ë¦¬ë¥¼ dbì— ë‚ ë ¤ì£¼ëŠ”ê±°ì•¼!!

```java
//em : EntityManager, transaction : EntityTransaction
transaction.begin();

em.persist(sample1);
em.persist(sample2);
//ì—¬ê¸°ê¹Œì§€ insert sqlì„ dbì— ë³´ë‚´ì§€ ì•Šì•„!!

transaction.commit();
//ì—¬ê¸°ì„œ ì´ì œ ë””ë¹„ì— insert sqlì„ ë‚ ë¦¬ëŠ”ê±°ì§€!!
```

ìœ„ì²˜ëŸ¼ ì´ë ‡ê²Œ ë””ë¹„ì— ì“°ëŠ”ìž‘ì—…ì„ ì§€ì—°ì‹œì¼°ë‹¤ê°€ íŠ¸ëžœì ì…˜ì´ commit ë  ë•Œ ìŠ¤ìœ½ ë‚ ë¦¬ëŠ” ê±¸ ì˜ë¯¸í•´!!

ê·¸ëŸ¼ commití•  ë•Œ ì–´ë–¤ì¼ì´ ì¼ì–´ë‚˜ê¸¸ëž˜ dbì— ì¿¼ë¦¬ê°€ ë‚ ë¼ê°€ëŠëƒ??

flushë¼ëŠ” ë™ìž‘ì„ í•˜ê²Œ ë˜ëŠ”ë° ì´ flush ë¼ëŠ” ì¹œêµ¬ê°€ 1ì°¨ ìºì‹œì—ì„œ ê´€ë¦¬í•˜ëŠ” Entityì™€ dbë¥¼ ë™ê¸°í™” í•´ì£¼ëŠ” ìž‘ì—…ì´ë¼ê³  ë³´ë©´ ë  ê±° ê°™ì• . 

ì‰½ê²Œ ë§í•˜ë©´ flushí•  ë•Œ ê·¸ëƒ¥ ì¿¼ë¦¬ê°€ ë‚ ë¼ê°„ë‹¤! ë¼ê³  ìƒê°í•˜ë©´ ë  ê±° ê°™ìœ¼.

**Dirty Checking**

dirty checkingì€ ë³€ê²½ê°ì§€ë¼ê³ ë„ í•´. ì˜ˆë¥¼ë“¤ì–´ ì˜ì†ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ë³€ê²½í•œë‹¤ë©´ ë”°ë¡œ updateí•˜ëŠ” ìž‘ì—…ì„ í•˜ì§€ ì•Šì•„ë„ dbì— ìžˆëŠ” ë°ì´í„°ì— ë³€ê²½ëœ ì •ë³´ë¡œ ë™ê¸°í™” ì‹œì¼œì¤€ë‹¤ëŠ” ê±°ì§€!!

```java
Sample s1 = em.find(Sample.class, "s1");

//ì˜ì† ì—”í‹°í‹° ìˆ˜ì •
s1.setNmae("new s1");

//em.update(s1) ì´ëŸ° ë†ˆì´ í•„ìš”ì—†ë‹¤ ì´ë§ì´ì•¼!!
transaction.commit();
```

ì´ë ‡ê²Œ ì•Œì•„ì„œ ë³€ê²½ì„ ê°ì§€í•´ì„œ ë””ë¹„ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸ ì‹œì¼œì¤˜!!

ì•„ì¥¬~ ì¢‹ì€ íŽ¸ë¦¬í•˜ë‹¤ ì´ë§ì´ì•¼~~

ìœ„ì—ì„œ ì´ì•¼ê¸°í•œ ê²ƒ ì²˜ëŸ¼ ë³€ê²½ì´ ë˜ì–´ì§ˆ ë•Œ updateì¿¼ë¦¬ë¥¼ ë§Œë“¤ì–´ ë†¨ë‹¤ê°€ commití•  ë•Œ ë³´ë‚´ë²„ë¦¬ëŠ” ê±°ê² ì§€.

ðŸ§ ìž ê¹!! í”ŒëŸ¬ì‹œ(flush)ì— ëŒ€í•´ ì¡°ê¸ˆ ë” ìžì„¸ížˆ ë³´ìž!

ì•„ê¹Œ commitì„ í•˜ë©´ fushë¥¼ í•¨ìœ¼ë¡œì¨ ì¿¼ë¦¬ ì €ìž¥ì†Œì— ìžˆë˜ ì¿¼ë¦¬ë¥¼ ë””ë¹„ì— ë‚ ë ¤ì¤˜ì„œ 1ì°¨ìºì‹œì™€ ë””ë¹„ì˜ ì •ë³´ë¥¼ ë™ê¸°í™”í•œë‹¤ëŠ” ë‚´ìš©ì´ ìžˆì—ˆëŠ”ë° ì¡°ê¸ˆ ë” ìžì„¸ížˆ ì•Œì•„ë³´ìž!!

ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ì• 

1. ë³€ê²½ì„ ê°ì§€í•´!!
2. ìˆ˜ì •ëœ ì—”í‹°í‹°ì— ëŒ€í•œ update ë¬¸ì„ ì“°ê¸° ì§€ì—° sql ì €ìž¥ì†Œì— ë“±ë¡í•´
3. ì“°ê¸° ì§€ì—° sql ì €ìž¥ì†Œì˜ ì¿¼ë¦¬ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì „ì†¡í•´!!

ìœ„ì™€ ê°™ì€ ê³¼ì •ìœ¼ë¡œ ë™ìž‘í•´!!

ê·¸ëŸ¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ flush í•˜ëŠ” ë°ì—ëŠ” commití•˜ëŠ” ë°©ë²• ë¿ì¼ê¹Œ?? ì•„ë‹ˆì•¼!! ì•„ëž˜ 3ê°€ì§€ ë°©ë²•ì´ ìžˆì–´!!

1. em.flush() ì§ì ‘ í˜¸ì¶œ
2. íŠ¸ëžœìž­ì…˜ ì»¤ë°‹ (flush ìžë™í˜¸ì¶œ)
3. jpql ì¿¼ë¦¬ ì‹¤í–‰ (flush ìžë™í˜¸ì¶œ)

ë¬¼ë¡  ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ë•Œ flush í˜¸ì¶œë˜ëŠ” ê²ƒì„ ì›ì¹˜ ì•ŠëŠ”ë‹¤ê³  í•œë‹¤ë©´ ì„¤ì •ì„ í†µí•´ ë³€ê²½í•  ìˆ˜ ìžˆì–´

```java
em.setFlushMode(FlushMoeType.AUTO); //ì»¤ë°‹ì´ë‚˜ ì¿¼ë¦¬ ì‹¤í–‰í•  ë•Œ í”ŒëŸ¬ì‹œ(default)
em.setFlushMode(FlushMoeType.COMMIT); //ì»¤ë°‹í•  ë•Œë§Œ í”ŒëŸ¬ì‹œ
```

í›„ ê·¸ëŸ¼ ì´ì–´ì„œ **ì¤€ì˜ì†** ìƒíƒœì— ëŒ€í•´ ì´ì•¼ê¸° í•´ ë³´ì¦ˆì•„!!

**ì¤€ì˜ì†ì€ ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ê°€ ì˜ì†ì„± ì»¨íƒìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬(detached)ëœ ìƒíƒœì•¼**

â†’ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì„ ë”ëŠ” ì‚¬ìš©í•˜ì§€ ëª»í•˜ê² ì§€

ì¤€ì˜ì† ìƒíƒœë¡œ ë§Œë“œë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ??

3ê°€ì§€ ë°©ë²•ì´ ìžˆë‹¤!!

1. em.detach(entity)  â†’ íŠ¹ì • ì—”í‹°í‹°ë§Œ ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜
2. em.clear() â†’ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì™„ì¦ˆì´ ì´ˆê¸°í™”
3. em.close() â†’ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¢…ë£Œ

ì´ìƒ!

> ì°¸ì¡° : [https://www.inflearn.com/course/ORM-JPA-Basic](https://www.inflearn.com/course/ORM-JPA-Basic)